第 3 章：实验步骤

3.1 数据准备

1、 建表
1）在“临时查询”页面右键“临时查询”，选择“新建节点”-> “ODPS SQL”



2） 在打开的文件窗口中，输入sql建表，然后点击“运行”。
建表语句见附件《SQL脚本.docx》第一部分。
共包含2张数据源表trips、stations，以及5张数据输出表hot_line、hot_stations、hot_hour、kpi_index、bike_control。



2、 上传数据集
本实验中原始数据集有两个：Trips.csv和stations.csv，均以csv格式的静态文本提供。用户需通过客户端数据上传的功能，将数据上传到MaxCompute中，作为实验的数据源。
下面提供两种数据导入方法：
①    页面导入，适用于文件大小不超过10M。
在“数据开发”菜单栏下点击“导入”，然后选择“导入本地数据”。将stations.csv数据文件导入到表stations中。


注意：数据文件的分隔符、字符集、以及首行是字段名还是数据。本数据文件中首行为数据，故而需把“首行为标题”选项勾去掉。



②   tunnel工具导入，对文件大小没有限制。
因Trips.csv数据文件大小超过10M，故而选择此种方式，将Trips.csv数据文件上传到表trips中。
首先，打开实验手册在第二章第3小节中配置好的tunnel客户端。

然后，打开“bin”文件夹，把要导入的数据集放在该文件夹下。
最后，双击运行odpscmd.bat，输入Tunnel命令。（说明：Linux 系统下运行 odpscmd，Windows 下运行 odpscmd.bat）
示例如下：

Tunnel命令为：tunnel upload Trips.csv trips;


3.2 数据分析

本小节将对利用MaxCompute工具对导入的数据集进行数据分析处理。
共分为两个任务：按日调度的“共享单车骑行分析”，以及按小时调度的“共享单车调度任务”。
其中共享单车骑行分析包含“热门线路”、“热门站点”、“高峰时段”、“KPI指标”四个数据加工节点。共享单车调度任务包含“站点存量数据”、“站点需求量数据”、“站点调度信息”三个数据加工节点。
1） 新建任务
在“数据开发”窗口，右键“业务流程”，选择“新建业务流程”

输入任务名称“共享单车骑行分析”，然后点击“创建”。

按此方法，再创建另一个任务“共享单车调度任务”。

2）创建虚节点
虚拟节点属于控制类节点，它是不产生任何数据的空跑节点，常用于业务流程的根节点。
在左侧“任务开发”选项卡中，双击任务，然后拖动节点组件“虚节点”到右侧空白区域。

3） 创建数据加工节点
在节点组件中，选择“ODPS_SQL”数据加工组件, 拖到右侧开发区域。然后把鼠标放在虚节点的底部正中间，当指针变成“+”时，按住鼠标左键拖动连线。


双击节点，可进行编辑。输入sql, 然后配置参数，最后点击“保存”，并“提交”。


按上述步骤依次编辑每个任务的各数据加工节点。Sql语句及参数见附件《SQL脚本.docx》第二部分。

编辑完成后，如下图所示：

4） 配置任务的调度属性
“共享单车骑行分析” 为日调度。设置每天凌晨3点执行。无上游依赖和跨周期依赖。节点默认调度为日调度，所以只需设置控制节点的调度日期即可，双击“共享单车控制节点”，进入调度配置

根节点作为流程入口，需配置上游任务为项目根目录，在当前界面继续配置调度依赖，保存

“共享单车调度任务” 为小时调度。设置每小时05分执行。无上游依赖和跨周期依赖。
5） 运行任务
提交任务

全选节点，自定义备注信息，勾选忽略输入输出不一致的告警（由于目前dataworks在依赖当前项目空间内的表时需要复杂的手动配置，否则会提示提交失败，因此勾选此项。）

点击工作面板右上角的“前往运维”按钮，进入“运维中心”界面。
说明：因当前测试数据集为201701-201703月历史数据，需手工执行补数据操作。而在实际生产环境中，数据是实时的，系统会按“调度配置”自动生成周期实例运行。

生成数据：
点击“周期任务”，选择“共享单车控制节点”，点击“补数据”，选择“当前节点及下游节点”

“共享单车骑行分析”任务的补数日期需设定在2017-01-01至2017-03-31之间，每天生成一个实例。因实验时间有限，建议选择最近的日期2017-03-29至2017-03-30，全选节点，能达到实验效果即可。

系统生成相应实例如下图所示：

共享单车调度任务构建完成后如下图所示

“共享单车调度任务” 为小时调度。设置每小时05分执行。无上游依赖和跨周期依赖。注意：小时调度需要对每个节点都设置小时调度
先对根节点进行调度配置
同样要配置根节点的调度依赖

对其余 三 个 节 点 都配置小时调度，调度时间可以不配置，会依赖根节点进行调度，只放了一个节点配置的图

提交时依然注意勾选忽略告警

同样的方法运行 得到数据



3.3 数据展现

本部分将数据处理完成的结果加载到Quick BI中进行可视化展现。
1）打开Quick BI服务
进入管理控制台，在左侧菜单栏“大数据（数加）”中选择“Quick BI”服务。



设置个人偏好。默认“使用物理字段名称”。便于理解，可设置成“使用字段注释”。（此步骤可选做）



2）添加数据源，选择“MaxCompute”,
 

输入实验时在MaxCompute 中创建的“项目名称”；access_id和access_key为开通资源时提供的密钥。

然后点击“连接测试”，待数据源测试连通后，再点击“添加”。
3）创建数据集
共需要创建5个数据集：hot_line、hot_stations、hot_hour、kpi_index、bike_control。
点击上述添加的数据源“MaxCompute”，在右侧窗口中选中要展现的表，然后点击“创建数据集”。

在“数据集”窗口，可查看全部数据集。
选中数据集，点击右侧“编辑”，可对数据集进行编辑。


下面以编辑数据集bike_control示例：

编辑数据集bike_control
右键点击度量中的“站点ID（station_id）”字段，选择”转换为维度”;
点击“保存”


编辑数据集kpi_index
右键点击维度中的“指标值（index_value）”字段，选择”转换为度量”;


右键点击度量中的 “指标值（index_value）”字段，选择“默认聚合方式”为“求和”；

点击“保存”

4）创建仪表板
打开“作品”，选择“新建”，然后点击“新建仪表板” 。

5） 配置仪表板
共包含5个数据图表和一个查询控件的设置。若时间有限，只配置其中一个图表，则该图表配置的数据集需与上述“创建数据集”步骤中编辑的数据集一致。
点击图表右上角可以删除图表

①    选择图表
在“数据图表”中，鼠标单击切换图表，双击即选中该图表。选中后，图表会添加到右侧空白区域。单击图表右上角的“…”可对图表执行其他操作。
实验中5个数据集对应的图表的选择如下：
KPI指标（kpi_index）：选用“指标看板”，用来一目了然的展示多个关键指标。

热门时段（hot_hour）：选用“线图”，展现数据变化的趋势、规律、峰值等特征。

热门站点（hot_stations）：选用“饼图”，显示排名前五的站点中，各站点需求的简单占比情况。

热门线路（hot_line）：选用交叉表，对数据做简单展示。
站点调度信息（bike_control）：选用交叉表，对数据做简单展示。


②    配置图表
下面以数据集kpi_index的展示图表 “指标看板”为例说明：
◎点击“指标看板”图表，在左上角“数据集”选项框选择kpi_index，
◎将“维度”中的“指标名称”，拖动到仪表板“数据”选项卡的“看板标签/维度”中，
◎将“度量”中的“指标值”，拖动到仪表板“数据”选项卡的“看板指标/度量”中，
◎将“维度”中的“日期”，拖动到仪表板“数据”选项卡的“过滤器”中，
◎将“数据”选项卡的预览行数设置为“5”，
◎编辑“样式”选项卡的“标题”，将“显示标题”勾上，名称为“KPI指标总览”，
◎编辑“样式”选项卡的“模板”，模板选择如下图所示，每行个数设置“5”，
◎点击“更新”，待页面中数据更新后，再点击“保存”。


 





本实验中，共有5个数据集，需配置五张图表。（如果时间有限，可选做其中一个）
其他四个数据集图表配置信息如下：
◆    数据集hot_hour，选用线图 。
◎点击“线图”图表，在左上角“数据集”选项框选择hot_hour，
◎将“维度”中的“时刻”，拖动到仪表板“数据”选项卡的“类别轴/维度”中，
◎将“度量”中的“频次”，拖动到仪表板“数据”选项卡的“值轴/度量”中，
◎将“维度”中的“日期”，拖动到仪表板“数据”选项卡的“过滤器”中，
◎将“数据”选项卡的预览行数设置为“24”，
◎编辑“样式”选项卡的“标题”，将“显示标题”勾上，名称为“骑行时刻趋势”，
◎编辑“样式”选项卡的“布局”，勾上“面积”、“曲线”、“显示Y轴”、“显示X轴”，
◎点击“更新”，待页面中数据更新后，再点击“保存”。




◆    数据集hot_stations，选用饼图 。
◎点击“饼图”图表，在左上角“数据集”选项框选择hot_stations，
◎将“维度”中的“站点名称”，拖动到仪表板“数据”选项卡的“扇区标签/维度”中，
◎将“度量”中的“频次”，拖动到仪表板“数据”选项卡的“扇区角度/度量”中，
◎将“维度”中的“日期”，拖动到仪表板“数据”选项卡的“过滤器”中，
◎将“数据”选项卡的预览行数设置为“5”，
◎编辑“样式”选项卡的“标题”，勾上“显示标题”，名称为“热门站点TOP5”，
◎编辑“样式”选项卡的“布局”，显示模式选择“3D”,标签样式“关闭”，
◎编辑“样式”选项卡的“设计”，勾上“显示图例”并选择“下”, 勾上“显示ToolTip”，
◎点击“更新”，待页面中数据更新后，再点击“保存”。





◆    数据集hot_line，选用交叉表 。
◎点击“交叉表”图表，在左上角“数据集”选项框选择hot_line，
◎将“维度”中的“起始站”、“到达站”，拖动到仪表板“数据”选项卡的“行（维度）”中，
◎将“度量”中的“序号”，拖动到仪表板“数据”选项卡的“列（度量）”中，
◎将“维度”中的“日期”，拖动到仪表板“数据”选项卡的“过滤器”中，
◎将“数据”选项卡的预览行数设置为“10”，点击“明细”，
◎编辑“样式”选项卡的“标题”，将“显示标题”勾上，名称为“热门线路TOP10”，
◎点击“更新”，待页面中数据更新后，再点击“保存”。





◆    数据集bike_control，选用交叉表 。
◎点击未配置的“交叉表”图表，在左上角“数据集”选项框选择bike_control，
◎将“维度”中的“时间”、”站点ID”、“站点名称”，拖动到仪表板“数据”选项卡的“行（维度）”中，
◎将“度量”中的“存量”、”需求量”、“可分配量”拖动到仪表板“数据”选项卡的“列（度量）”中，
◎将“维度”中的“日期”，拖动到仪表板“数据”选项卡的“过滤器”中，
◎将“数据”选项卡的预览行数设置为“600”，点击“明细”，
◎编辑“样式”选项卡的“标题”，将“显示标题”勾上，名称为“站点车辆调度分配”，
◎编辑“样式”选项卡的“布局”，勾上“显示序号”，
◎点击“更新”，待页面中数据更新后，再点击“保存”。





配置查询条件
选中“配置仪表板”》“控件”》“查询条件”控件，点击控件的标题区，可拖动控排版，将控件拖到页面上方。
单击“查询条件”控件，配置“数据”选项卡中的“源数据集”为“kpi_index”，字段选择勾上“pt”

然后在“同源关联”中勾上“图表-KPI指标总览”，在“非同源关联”中勾上其他各个图表的“日期”。

点击筛选条件输入框，在左侧“筛选”选项卡中输入标签名为“日期”，选择“枚举”选项为“单选”


将每个图的过滤器都进行如下配置，保存后点击更新



④   预览展示
点击页面上方的“保存”按钮，然后点击“预览”，可查看页面效果。

仪表板配置完成后，展示效果如下
